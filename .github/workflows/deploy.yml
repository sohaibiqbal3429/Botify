name: Deploy Botify to VPS

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.5.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Restore Next.js cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            next-cache-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Upload Next.js cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-cache-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            next-cache-${{ runner.os }}-

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            #!/usr/bin/env bash
            set -euo pipefail

            APP_DIR="/var/www/botify"
            BRANCH="main"
            PREV_COMMIT="$(cd "$APP_DIR" && git rev-parse HEAD || echo "")"

            cd "$APP_DIR"

            echo "==> Pull latest"
            git fetch --all
            git reset --hard "origin/$BRANCH"

            export PNPM_HOME="$HOME/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH"
            corepack enable pnpm

            echo "==> Install deps (prefer cache)"
            pnpm install --frozen-lockfile --prefer-offline --prod

            echo "==> Build"
            pnpm build

            echo "==> Restart PM2"
            pm2 start ecosystem.config.cjs --update-env || pm2 restart botify --update-env
            pm2 save

            echo "==> Health check"
            if ! curl -fsS --max-time 8 http://127.0.0.1:3000/api/health; then
              echo "Health check failed, rolling back"
              if [ -n "$PREV_COMMIT" ]; then
                git reset --hard "$PREV_COMMIT"
                pnpm install --frozen-lockfile --prefer-offline --prod
                pnpm build
                pm2 restart botify --update-env
              fi
              exit 1
            fi

            echo "âœ… Deploy done"
